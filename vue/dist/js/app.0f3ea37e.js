(function(){"use strict";var t={8529:function(t,e,s){var i=s(5471),n=function(){var t=this,e=t._self._c;return e("div",{attrs:{id:"app"}},[e("header",{staticStyle:{padding:"12px 16px","border-bottom":"1px solid #e5e7eb",display:"flex","align-items":"center",gap:"8px"}},[e("h1",{staticStyle:{"font-size":"20px","margin-right":"16px"}},[t._v("MVdecision Pose Search")]),e("button",{class:["tab-btn","editor"===t.currentPage?"active":""],on:{click:function(e){t.currentPage="editor"}}},[t._v(" ポーズ編集・検索 ")]),e("button",{class:["tab-btn","upload"===t.currentPage?"active":""],on:{click:function(e){t.currentPage="upload"}}},[t._v(" データセット登録 ")]),t.searchStatusText?e("div",{staticStyle:{"margin-left":"auto","font-size":"12px",color:"#6b7280"}},[t._v(" "+t._s(t.searchStatusText)+" ")]):t._e()]),e("main",{staticStyle:{padding:"0"}},["editor"===t.currentPage?e("coco-pose-editor",{on:{search:t.handleSearch}}):e("dataset-upload")],1)])},o=[],a=function(){var t=this,e=t._self._c;return e("div",{staticClass:"w-full h-full",staticStyle:{padding:"16px"}},[e("div",{staticStyle:{display:"flex","flex-wrap":"wrap",gap:"8px","align-items":"center","margin-bottom":"12px"}},[e("strong",[t._v("CocoPoseEditor (Vue 2)")]),e("button",{on:{click:function(e){return t.onRotate(-15)}}},[t._v("Rotate -15°")]),e("button",{on:{click:function(e){return t.onRotate(15)}}},[t._v("Rotate +15°")]),e("button",{on:{click:function(e){return t.onScale(.9)}}},[t._v("Scale 90%")]),e("button",{on:{click:function(e){return t.onScale(1.1)}}},[t._v("Scale 110%")]),e("button",{on:{click:t.onMirror}},[t._v("Mirror LR")]),e("label",{staticStyle:{"margin-left":"8px"}},[e("input",{directives:[{name:"model",rawName:"v-model",value:t.ikEnabled,expression:"ikEnabled"}],attrs:{type:"checkbox"},domProps:{checked:Array.isArray(t.ikEnabled)?t._i(t.ikEnabled,null)>-1:t.ikEnabled},on:{change:function(e){var s=t.ikEnabled,i=e.target,n=!!i.checked;if(Array.isArray(s)){var o=null,a=t._i(s,o);i.checked?a<0&&(t.ikEnabled=s.concat([o])):a>-1&&(t.ikEnabled=s.slice(0,a).concat(s.slice(a+1)))}else t.ikEnabled=n}}}),t._v(" 2-bone IK (wrists/ankles) ")]),e("button",{staticStyle:{"margin-left":"8px"},on:{click:t.onReset}},[t._v("Reset")]),e("button",{staticStyle:{"margin-left":"4px"},on:{click:t.onSavePose}},[t._v("Save pose")]),e("button",{staticStyle:{"margin-left":"8px"},on:{click:t.onExport}},[t._v("Export JSON")]),e("button",{staticClass:"btn-search",staticStyle:{"margin-left":"8px"},on:{click:t.onSearch}},[t._v("検索")]),e("label",{staticStyle:{"margin-left":"8px",cursor:"pointer"}},[t._v(" Import JSON "),e("input",{staticStyle:{display:"none"},attrs:{type:"file",accept:"application/json"},on:{change:t.onImport}})]),e("label",{staticStyle:{"margin-left":"8px",cursor:"pointer"}},[t._v(" Background "),e("input",{staticStyle:{display:"none"},attrs:{type:"file",accept:"image/*"},on:{change:t.onBgUpload}})])]),e("div",{staticStyle:{border:"1px solid #ddd","border-radius":"12px",overflow:"hidden"}},[e("canvas",{ref:"canvas",attrs:{width:t.W,height:t.H},on:{mousedown:t.onMouseDown,mousemove:t.onMouseMove,mouseup:t.onMouseUp,mouseleave:t.onMouseUp}})]),e("p",{staticStyle:{color:"#555","margin-top":"10px"}},[t._v(" 使い方：青い点（関節）をドラッグで配置。グレーは保存済みのポーズ。 手首/足首をドラッグすると、肘/膝が長さを保って追従（2-bone IK）。 Mirror/Rotate/Scale/Reset、背景画像、JSON入出力、ポーズ保存、検索に対応。 ")]),t.results.length?e("div",{staticClass:"search-results"},[e("h3",[t._v("検索結果（"+t._s(t.results.length)+"件）")]),e("div",{staticClass:"grid"},t._l(t.results,function(s){return e("div",{key:s.id,staticClass:"card"},[e("div",{staticClass:"thumb-wrap"},[e("img",{attrs:{src:t.imageUrl(s),alt:"pose result",loading:"lazy"},on:{error:t.onImgError}})]),e("div",{staticClass:"meta"},[e("div",{staticClass:"title"},[t._v(t._s(s.displayPath))]),e("div",{staticClass:"distance"},[t._v("dist: "+t._s(s.distance.toFixed(3)))])])])}),0)]):t.searchedOnce?e("div",{staticClass:"search-empty"},[e("em",[t._v("該当なし、または距離がしきい値を超えているため表示されていません。")])]):t._e()])},r=[],l=(s(4114),s(8111),s(7588),s(1701),s(8237),s(4603),s(7566),s(8721),s(4335)),c={name:"CocoPoseEditor",data(){const t=1200,e=800;return{W:t,H:e,ctx:null,points:d(t,e),savedPoses:[],currentVersion:-1,dragIdx:null,ikEnabled:!0,bgImg:null,featurePreview:null,results:[],searchedOnce:!1}},mounted(){const t=this.$refs.canvas.getContext("2d");this.ctx=t,this.draw()},beforeDestroy(){window.removeEventListener("mousemove",this.onMouseMove),window.removeEventListener("mouseup",this.onMouseUp)},watch:{points:{deep:!0,handler(){this.draw()}},bgImg(){this.draw()}},computed:{center(){const t=this.points[11],e=this.points[12];return[.5*(t[0]+e[0]),.5*(t[1]+e[1])]}},methods:{draw(){if(!this.ctx)return;const t=this.ctx,{W:e,H:s}=this;t.clearRect(0,0,e,s),t.fillStyle="#fff",t.fillRect(0,0,e,s),this.bgImg&&t.drawImage(this.bgImg,0,0,e,s),this.savedPoses.forEach(e=>{const s=e.points;t.lineWidth=2,t.strokeStyle="rgba(107,114,128,0.5)",p.forEach(([e,i])=>{const n=s[e],o=s[i];n&&o&&(t.beginPath(),t.moveTo(n[0],n[1]),t.lineTo(o[0],o[1]),t.stroke())}),s.forEach(e=>{t.beginPath(),t.arc(e[0],e[1],5,0,2*Math.PI),t.fillStyle="rgba(156,163,175,0.9)",t.fill()})}),t.lineWidth=3,t.strokeStyle="#1f2937",p.forEach(([e,s])=>{const i=this.points[e],n=this.points[s];i&&n&&(t.beginPath(),t.moveTo(i[0],i[1]),t.lineTo(n[0],n[1]),t.stroke())}),this.points.forEach((e,s)=>{t.beginPath(),t.arc(e[0],e[1],7,0,2*Math.PI),t.fillStyle=s===this.dragIdx?"#f59e0b":"#2563eb",t.fill(),t.font="12px Menlo, ui-monospace",t.fillStyle="#111827",t.fillText(`${s}:${h[s]}`,e[0]+10,e[1]-10)})},pick(t,e){for(let s=this.points.length-1;s>=0;s--){const i=this.points[s];if(Math.hypot(i[0]-t,i[1]-e)<=10)return s}return null},toCanvasXY(t){const e=this.$refs.canvas.getBoundingClientRect(),s=this.W/e.width,i=this.H/e.height,n=(t.clientX-e.left)*s,o=(t.clientY-e.top)*i;return[n,o]},onMouseDown(t){const[e,s]=this.toCanvasXY(t);this.dragIdx=this.pick(e,s),null!==this.dragIdx&&(window.addEventListener("mousemove",this.onMouseMove),window.addEventListener("mouseup",this.onMouseUp),this.onMouseMove(t))},onMouseMove(t){if(null===this.dragIdx)return;const[e,s]=this.toCanvasXY(t),i=this.points.map(t=>[t[0],t[1]]),n=this.dragIdx,o=9===n,a=10===n,r=15===n,l=16===n,c=()=>{i[n]=[e,s]};if(this.ikEnabled&&(o||a||r||l)){if(o){const{newJoint:t,newEnd:n}=u(i[5],i[7],i[9],[e,s]);i[7]=t,i[9]=n}else if(a){const{newJoint:t,newEnd:n}=u(i[6],i[8],i[10],[e,s]);i[8]=t,i[10]=n}else if(r){const{newJoint:t,newEnd:n}=u(i[11],i[13],i[15],[e,s]);i[13]=t,i[15]=n}else if(l){const{newJoint:t,newEnd:n}=u(i[12],i[14],i[16],[e,s]);i[14]=t,i[16]=n}}else c();this.points=i},onMouseUp(){this.dragIdx=null,window.removeEventListener("mousemove",this.onMouseMove),window.removeEventListener("mouseup",this.onMouseUp)},transformAll(t){this.points=this.points.map(t)},onMirror(){const t=this.center[0];this.transformAll(e=>[2*t-e[0],e[1]]);const e=(t,e)=>{const s=this.points[t];this.points[t]=this.points[e],this.points[e]=s};[[1,2],[3,4],[5,6],[7,8],[9,10],[11,12],[13,14],[15,16]].forEach(([t,s])=>e(t,s)),this.draw()},onRotate(t){const e=t*Math.PI/180,s=Math.cos(e),i=Math.sin(e),n=this.center;this.transformAll(t=>{const e=[t[0]-n[0],t[1]-n[1]],o=[e[0]*s-e[1]*i,e[0]*i+e[1]*s];return[n[0]+o[0],n[1]+o[1]]}),this.draw()},onScale(t){const e=this.center;this.transformAll(s=>[e[0]+(s[0]-e[0])*t,e[1]+(s[1]-e[1])*t]),this.draw()},onReset(){if(-1===this.currentVersion)this.points=d(this.W,this.H);else{const t=this.savedPoses[this.currentVersion];if(!t)return;if(this.points=t.points.map(t=>[t[0],t[1]]),this.currentVersion=Math.max(-1,this.currentVersion-1),this.currentVersion>=0){const t=this.savedPoses[this.currentVersion];t&&(this.points=t.points.map(t=>[t[0],t[1]]))}else this.points=d(this.W,this.H)}},onSavePose(){const t=this.points.map(t=>[t[0],t[1]]);this.savedPoses.push({points:t}),this.currentVersion=this.savedPoses.length-1,this.points=t.map(t=>[t[0],t[1]]),this.draw()},async onSearch(){try{const t=this.points.map(t=>[t[0],t[1]]),e=await l.A.post("/api/query/pose/feature",{keypoints:t}),s=e.data.featureVector,i=await l.A.post("/api/query/pose/search",{featureVector:s,topK:15});this.featurePreview={featureVector:i.data.featureVector},this.results=(i.data.results||[]).map(t=>({id:t.id,datasetName:t.datasetName,imageFileName:t.imageFileName,imagePath:t.imagePath,sourceImagePath:t.sourceImagePath,distance:t.distance,displayPath:t.displayPath||`${t.datasetName}/${t.imageFileName}`})),this.searchedOnce=!0}catch(t){console.error("Search failed:",t),alert("検索に失敗しました。サーバのログを確認してください。")}},imageUrl(t){return`/api/images/${t.id}`},onImgError(t){t.target.src="data:image/svg+xml;utf8,"+encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="240" height="180"><rect width="100%" height="100%" fill="#eee"/><text x="50%" y="50%" text-anchor="middle" fill="#999" font-size="16">No Image</text></svg>')},onExport(){const t={keypoints:this.points.map((t,e)=>({id:e,name:h[e],x:t[0],y:t[1],v:2})),width:this.W,height:this.H},e=new Blob([JSON.stringify(t,null,2)],{type:"application/json"}),s=URL.createObjectURL(e),i=document.createElement("a");i.href=s,i.download="coco17_query.json",i.click(),URL.revokeObjectURL(s)},onImport(t){const e=t.target.files&&t.target.files[0];if(!e)return;const s=new FileReader;s.onload=()=>{try{const t=JSON.parse(String(s.result)),e=Array.isArray(t.persons)?t.persons:[];if(!e.length)throw new Error("persons array is empty");const i=t=>{let e=null,s=-1/0;return t.forEach(t=>{const i=Array.isArray(t.keypoint_scores)&&t.keypoint_scores.length?t.keypoint_scores.reduce((t,e)=>t+Number(e||0),0)/t.keypoint_scores.length:0;i>s&&(s=i,e=t)}),e||t[0]},n=i(e),o=Array.isArray(n.keypoints)?n.keypoints:[];let a=o.map(t=>[Number(t[0])||0,Number(t[1])||0]).slice(0,17);while(a.length<17)a.push(a[a.length-1]?[...a[a.length-1]]:[0,0]);const r=f(a,this.W,this.H,40);this.points=r}catch(t){console.warn("Invalid Import JSON:",t),alert("Import 失敗：JSON 形式を確認してください。")}},s.readAsText(e)},onBgUpload(t){const e=t.target.files&&t.target.files[0];if(!e)return;const s=URL.createObjectURL(e),i=new Image;i.onload=()=>{this.bgImg=i,this.draw()},i.src=s}}};const h=["nose","left_eye","right_eye","left_ear","right_ear","left_shoulder","right_shoulder","left_elbow","right_elbow","left_wrist","right_wrist","left_hip","right_hip","left_knee","right_knee","left_ankle","right_ankle"],p=[[5,7],[7,9],[6,8],[8,10],[11,13],[13,15],[12,14],[14,16],[5,6],[11,12],[5,11],[6,12],[0,1],[0,2],[1,3],[2,4],[0,5],[0,6]];function d(t,e){const s=.35*t,i=.35*e,n=.15*Math.min(t,e),o=Array(17).fill(0).map(()=>[s,i]);return o[11]=[s-.25*n,i+.7*n],o[12]=[s+.25*n,i+.7*n],o[5]=[s-.35*n,i+.2*n],o[6]=[s+.35*n,i+.2*n],o[7]=[s-.7*n,i+.25*n],o[8]=[s+.7*n,i+.25*n],o[9]=[s-n,i+.3*n],o[10]=[s+n,i+.3*n],o[13]=[s-.2*n,i+1.2*n],o[14]=[s+.2*n,i+1.2*n],o[15]=[s-.18*n,i+1.7*n],o[16]=[s+.18*n,i+1.7*n],o[0]=[s,i-.2*n],o[1]=[s-.08*n,i-.22*n],o[2]=[s+.08*n,i-.22*n],o[3]=[s-.14*n,i-.18*n],o[4]=[s+.14*n,i-.18*n],o}function u(t,e,s,i){const n=(t,e)=>[t[0]-e[0],t[1]-e[1]],o=(t,e)=>[t[0]+e[0],t[1]+e[1]],a=(t,e)=>[t[0]*e,t[1]*e],r=t=>Math.hypot(t[0],t[1]),l=t=>{const e=r(t);return e>1e-8?[t[0]/e,t[1]/e]:[0,0]},c=(t,e,s)=>Math.min(Math.max(t,e),s),h=t,p=n(e,t),d=r(p),u=r(n(s,e)),f=n(i,h),g=Math.max(1e-6,Math.min(r(f),d+u-1e-6)),m=l(f),v=c((d*d+g*g-u*u)/(2*d*g),-1,1),y=Math.sqrt(Math.max(0,1-v*v)),b=Math.sign(m[0]*p[1]-m[1]*p[0])||1,_=[-m[1],m[0]],x=o(h,o(a(m,d*v),a(_,d*y*b))),w=o(x,a(l(n(i,x)),u));return{newJoint:x,newEnd:w}}function f(t,e,s,i=40){let n=1/0,o=1/0,a=-1/0,r=-1/0;if(t.forEach(([t,e])=>{Number.isFinite(t)&&Number.isFinite(e)&&(t<n&&(n=t),e<o&&(o=e),t>a&&(a=t),e>r&&(r=e))}),!isFinite(n)||!isFinite(o)||!isFinite(a)||!isFinite(r))return d(e,s);const l=Math.max(1,a-n),c=Math.max(1,r-o),h=(e-2*i)/l,p=(s-2*i)/c,u=Math.min(h,p),f=e/2,g=s/2,m=(n+a)/2,v=(o+r)/2;return t.map(([t,e])=>{const s=(t-m)*u+f,i=(e-v)*u+g;return[s,i]})}var g=c,m=s(1656),v=(0,m.A)(g,a,r,!1,null,"e4c68e96",null),y=v.exports,b=function(){var t=this,e=t._self._c;return e("div",{staticClass:"dataset-upload",staticStyle:{padding:"16px"}},[e("h2",{staticStyle:{"font-size":"20px","margin-bottom":"8px"}},[t._v("データセット登録（画像＋JSON zip）")]),t._m(0),e("div",{staticStyle:{border:"1px solid #ddd","border-radius":"12px",padding:"16px","max-width":"520px"}},[e("input",{attrs:{type:"file",accept:".zip"},on:{change:t.onFileChange}}),t.selectedFile?e("div",{staticStyle:{"margin-top":"8px"}},[t._v(" 選択中: "),e("strong",[t._v(t._s(t.selectedFile.name))])]):t._e(),e("button",{staticStyle:{"margin-top":"12px"},attrs:{disabled:!t.selectedFile||t.uploading},on:{click:t.onUpload}},[t._v(" "+t._s(t.uploading?"アップロード中...":"アップロード")+" ")]),t.message?e("p",{style:{marginTop:"12px",color:t.messageColor}},[t._v(" "+t._s(t.message)+" ")]):t._e()]),t._m(1)])},_=[function(){var t=this,e=t._self._c;return e("p",{staticStyle:{"margin-bottom":"12px",color:"#555"}},[t._v(" 画像と "),e("code",[t._v("*_keypoints.json")]),t._v(" がペアになったディレクトリを zip にしてアップロードします。"),e("br"),t._v(" 例: "),e("code",[t._v("A001.png")]),t._v(" と "),e("code",[t._v("A001_keypoints.json")]),t._v(" がセット。 ")])},function(){var t=this,e=t._self._c;return e("p",{staticStyle:{"margin-top":"16px",color:"#777","font-size":"13px"}},[t._v(" ※ バックエンド側では、zip を展開して画像と JSON を読み取り、"),e("br"),t._v(" スケルトン17点を正規化した上でデータベースに格納する処理を実装します。 ")])}],x={name:"DatasetUpload",data(){return{selectedFile:null,uploading:!1,message:"",messageColor:"#16a34a"}},methods:{onFileChange(t){const e=t.target.files&&t.target.files[0];this.selectedFile=e||null,this.message=""},async onUpload(){if(this.selectedFile){this.uploading=!0,this.message="";try{const t=new FormData;t.append("file",this.selectedFile),await l.A.post("/api/dataset/uploadZip",t,{headers:{"Content-Type":"multipart/form-data"}}),this.message="アップロードに成功しました。",this.messageColor="#16a34a",this.selectedFile=null}catch(t){console.error(t),this.message="アップロードに失敗しました（バックエンド未実装の可能性）。",this.messageColor="#dc2626"}finally{this.uploading=!1}}}}},w=x,S=(0,m.A)(w,b,_,!1,null,"4abf7bad",null),k=S.exports,M={name:"App",components:{CocoPoseEditor:y,DatasetUpload:k},data(){return{currentPage:"editor",isSearching:!1,searchStatusText:""}},methods:{async handleSearch(t){console.log("Search pose payload:",t),this.isSearching=!0,this.searchStatusText="検索中...";try{const e=await l.A.post("/api/search/pose",t);console.log("Search result:",e.data),this.searchStatusText="検索完了（バックエンドのレスポンスを画面に反映予定）"}catch(e){console.error(e),this.searchStatusText="検索エラー（バックエンド未実装の可能性）"}finally{this.isSearching=!1}}}},E=M,P=(0,m.A)(E,n,o,!1,null,null,null),I=P.exports;i.Ay.config.productionTip=!1,new i.Ay({render:t=>t(I)}).$mount("#app")}},e={};function s(i){var n=e[i];if(void 0!==n)return n.exports;var o=e[i]={exports:{}};return t[i].call(o.exports,o,o.exports,s),o.exports}s.m=t,function(){var t=[];s.O=function(e,i,n,o){if(!i){var a=1/0;for(h=0;h<t.length;h++){i=t[h][0],n=t[h][1],o=t[h][2];for(var r=!0,l=0;l<i.length;l++)(!1&o||a>=o)&&Object.keys(s.O).every(function(t){return s.O[t](i[l])})?i.splice(l--,1):(r=!1,o<a&&(a=o));if(r){t.splice(h--,1);var c=n();void 0!==c&&(e=c)}}return e}o=o||0;for(var h=t.length;h>0&&t[h-1][2]>o;h--)t[h]=t[h-1];t[h]=[i,n,o]}}(),function(){s.d=function(t,e){for(var i in e)s.o(e,i)&&!s.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:e[i]})}}(),function(){s.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(t){if("object"===typeof window)return window}}()}(),function(){s.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)}}(),function(){s.r=function(t){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}}(),function(){var t={524:0};s.O.j=function(e){return 0===t[e]};var e=function(e,i){var n,o,a=i[0],r=i[1],l=i[2],c=0;if(a.some(function(e){return 0!==t[e]})){for(n in r)s.o(r,n)&&(s.m[n]=r[n]);if(l)var h=l(s)}for(e&&e(i);c<a.length;c++)o=a[c],s.o(t,o)&&t[o]&&t[o][0](),t[o]=0;return s.O(h)},i=self["webpackChunkcoco_pose_editor_vue2"]=self["webpackChunkcoco_pose_editor_vue2"]||[];i.forEach(e.bind(null,0)),i.push=e.bind(null,i.push.bind(i))}();var i=s.O(void 0,[504],function(){return s(8529)});i=s.O(i)})();
//# sourceMappingURL=app.0f3ea37e.js.map